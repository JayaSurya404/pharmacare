const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const bcrypt = require("bcryptjs");

const app = express();

// ================== MIDDLEWARE ==================
app.use(cors());
app.use(express.json());

// ================== DATABASE CONNECTION ==================
mongoose
  .connect("mongodb://127.0.0.1:27017/pharmacyDB", {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("âœ… MongoDB connected"))
  .catch((err) => console.error("âŒ MongoDB connection error:", err));

// ================== SCHEMAS ==================

// User Schema
const userSchema = new mongoose.Schema({
  fullname: { type: String, required: true },
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  userType: { type: String, enum: ["customer", "pharmacy"], default: "customer" },
});
const User = mongoose.model("User", userSchema);

// Customer Profile Schema
const customerProfileSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: "User", required: true },
  name: String,
  email: String,
  medicines: [
    {
      name: String,
      dosage: String,
      refillDate: String,
      status: String,
      category: String,
    },
  ],
  memberSince: { type: Date, default: Date.now },
});
const CustomerProfile = mongoose.model("CustomerProfile", customerProfileSchema);

// Pharmacy Profile Schema
const pharmacyProfileSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: "User", required: true },
  name: String,
  email: String,
  storeName: String,
  medicines: [
    {
      _id: String,
      name: String,
      stock: Number,
      price: Number,
      expiryDate: String,
      status: String,
      brand: String,
      category: String,
      description: String,
      image: String,
      requiresPrescription: Boolean,
      batchNumber: String,
      manufactureDate: String,
      pharmacyEmail: String,
    },
  ],
  // Extra profile fields
  fullName: String,
  phone: String,
  address: String,
  bio: String,
  pharmacyName: String,
  licenseNumber: String,
  shopAddress: String,
  shopPhone: String,
  shopDescription: String,
  shopHours: String,
  profilePhoto: String,
  shopPhoto: String,
  memberSince: { type: Date, default: Date.now },
});
const PharmacyProfile = mongoose.model("PharmacyProfile", pharmacyProfileSchema);

// Request Schema
const requestSchema = new mongoose.Schema({
  pharmacyId: { type: mongoose.Schema.Types.ObjectId, ref: "PharmacyProfile", required: true },
  customerName: { type: String, required: true },
  medicineName: { type: String, required: true },
  time: { type: String, required: true },
});
const Request = mongoose.model("Request", requestSchema);

// ================== ROUTES ==================

// Test Route
app.get("/api/test", (req, res) => res.json({ message: "Backend is connected âœ…" }));

// -------------------- AUTH ROUTES --------------------
app.post("/api/signup", async (req, res) => {
  try {
    const { fullname, email, password, userType } = req.body;
    const existingUser = await User.findOne({ email });
    if (existingUser) return res.status(400).json({ message: "Email already exists âŒ" });

    const hashedPassword = await bcrypt.hash(password, 10);
    const newUser = new User({ fullname, email, password: hashedPassword, userType });
    await newUser.save();

    if (userType === "customer") {
      await CustomerProfile.create({ userId: newUser._id, name: fullname, email, medicines: [] });
    } else if (userType === "pharmacy") {
      await PharmacyProfile.create({ userId: newUser._id, name: fullname, email, storeName: "My Pharmacy", medicines: [] });
    }

    res.status(201).json({ message: "Signup successful ðŸŽ‰" });
  } catch (err) {
    console.error("Signup error:", err);
    res.status(500).json({ message: "Something went wrong on the server âŒ" });
  }
});

app.post("/api/login", async (req, res) => {
  try {
    const { email, password } = req.body;
    const user = await User.findOne({ email });
    if (!user) return res.status(400).json({ message: "Invalid credentials âŒ" });

    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) return res.status(400).json({ message: "Invalid credentials âŒ" });

    res.json({ message: "Login successful ðŸŽ‰", user });
  } catch (err) {
    console.error("Login error:", err);
    res.status(500).json({ message: "Something went wrong on the server âŒ" });
  }
});

// -------------------- CUSTOMER ROUTES --------------------
app.get("/api/customer/:email/profile", async (req, res) => {
  try {
    const profile = await CustomerProfile.findOne({ email: req.params.email });
    if (!profile) return res.status(404).json({ message: "Customer profile not found" });
    res.json(profile);
  } catch (err) {
    res.status(500).json({ message: "Error fetching customer profile" });
  }
});

app.get("/api/customer/:email/medicines", async (req, res) => {
  try {
    const profile = await CustomerProfile.findOne({ email: req.params.email }, { medicines: 1 });
    if (!profile) return res.status(404).json({ message: "Customer medicines not found" });
    res.json(profile.medicines);
  } catch (err) {
    res.status(500).json({ message: "Error fetching medicines" });
  }
});

// -------------------- PHARMACY ROUTES --------------------

// Get Pharmacy Profile
app.get("/api/pharmacy/:email/profile", async (req, res) => {
  try {
    const pharmacy = await PharmacyProfile.findOne({ email: req.params.email });
    if (!pharmacy) return res.status(404).json({ message: "Pharmacy not found" });

    res.json({
      _id: pharmacy._id,
      userId: pharmacy.userId,
      fullName: pharmacy.fullName,
      name: pharmacy.name,
      email: pharmacy.email,
      phone: pharmacy.phone,
      address: pharmacy.address,
      bio: pharmacy.bio,
      storeName: pharmacy.storeName,
      pharmacyName: pharmacy.pharmacyName,
      licenseNumber: pharmacy.licenseNumber,
      memberSince: pharmacy.memberSince,
      shopAddress: pharmacy.shopAddress,
      shopPhone: pharmacy.shopPhone,
      shopDescription: pharmacy.shopDescription,
      shopHours: pharmacy.shopHours,
      profilePhoto: pharmacy.profilePhoto,
      shopPhoto: pharmacy.shopPhoto,
      medicines: pharmacy.medicines || [],
    });
  } catch (err) {
    console.error("Error fetching pharmacy profile:", err);
    res.status(500).json({ message: "Error fetching pharmacy profile" });
  }
});

// âœ… Update Pharmacy Profile
app.put("/api/pharmacy/:email/updateProfile", async (req, res) => {
  try {
    const { email } = req.params;
    const data = req.body;

    const profile = await PharmacyProfile.findOne({ email });
    if (!profile) return res.status(404).json({ message: "Pharmacy not found âŒ" });

    const allowedFields = [
      "fullName", "name", "phone", "address", "bio",
      "pharmacyName", "licenseNumber", "shopAddress",
      "shopPhone", "shopDescription", "shopHours",
      "profilePhoto", "shopPhoto", "storeName"
    ];

    allowedFields.forEach((field) => {
      if (data[field] !== undefined) profile[field] = data[field];
    });

    await profile.save();
    res.json({ message: "Profile updated successfully âœ…", profile });

  } catch (err) {
    console.error("Error updating pharmacy profile:", err);
    res.status(500).json({ message: "Error updating profile âŒ" });
  }
});

// Get Pharmacy Inventory
app.get("/api/pharmacy/:email/inventory", async (req, res) => {
  try {
    const profile = await PharmacyProfile.findOne({ email: req.params.email }, { medicines: 1 });
    if (!profile) return res.status(404).json({ message: "Pharmacy inventory not found" });

    const medicinesWithId = profile.medicines.map((med) => ({
      _id: med._id,
      name: med.name,
      brand: med.brand || "",
      category: med.category || "",
      description: med.description || "",
      price: med.price,
      stock: med.stock,
      expiryDate: med.expiryDate,
      status: med.status,
      image: med.image || "/medicine.png",
      requiresPrescription: med.requiresPrescription || false,
      batchNumber: med.batchNumber || "",
      manufactureDate: med.manufactureDate || "",
      pharmacyEmail: med.pharmacyEmail || profile.email,
    }));

    res.json(medicinesWithId);
  } catch (err) {
    console.error("Error fetching inventory:", err);
    res.status(500).json({ message: "Error fetching inventory" });
  }
});

// -------------------- PHARMACY MEDICINE ROUTES (FRONTEND COMPATIBLE) --------------------

// Update Medicine
app.put("/api/pharmacy/:email/medicines/:medicineId", async (req, res) => {
  try {
    const { email, medicineId } = req.params;
    const { name, price } = req.body;

    const profile = await PharmacyProfile.findOne({ email });
    if (!profile) return res.status(404).json({ message: "Pharmacy not found" });

    const medicine = profile.medicines.find((m) => m._id === medicineId);
    if (!medicine) return res.status(404).json({ message: "Medicine not found" });

    if (name !== undefined) medicine.name = name;
    if (price !== undefined) medicine.price = price;

    await profile.save();
    res.json({ message: "Medicine updated successfully âœ…", medicine });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Error updating medicine" });
  }
});

// Restock Medicine
app.put("/api/pharmacy/:email/medicines/:medicineId/restock", async (req, res) => {
  try {
    const { email, medicineId } = req.params;
    const { stock } = req.body;

    const profile = await PharmacyProfile.findOne({ email });
    if (!profile) return res.status(404).json({ message: "Pharmacy not found" });

    const medicine = profile.medicines.find((m) => m._id === medicineId);
    if (!medicine) return res.status(404).json({ message: "Medicine not found" });

    medicine.stock += stock;
    await profile.save();
    res.json({ message: "Medicine restocked successfully âœ…", medicine });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Error restocking medicine" });
  }
});

// Get Requests
app.get("/api/pharmacy/:email/requests", async (req, res) => {
  try {
    const pharmacy = await PharmacyProfile.findOne({ email: req.params.email });
    if (!pharmacy) return res.status(404).json({ message: "Pharmacy not found" });

    const requests = await Request.find({ pharmacyId: pharmacy._id });
    res.json(requests);
  } catch (err) {
    console.error("Error fetching requests:", err);
    res.status(500).json({ message: "Error fetching requests" });
  }
});

// -------------------- CUSTOMER SEARCH SYSTEM --------------------

// Search Medicines Across Pharmacies
app.get("/api/search-medicine", async (req, res) => {
  try {
    const { name } = req.query;
    if (!name) return res.status(400).json({ message: "Medicine name is required âŒ" });

    const regex = new RegExp(name, "i");
    const pharmacies = await PharmacyProfile.find({ "medicines.name": regex });

    const results = [];
    pharmacies.forEach((pharmacy) => {
      pharmacy.medicines
        .filter((m) => regex.test(m.name))
        .forEach((m) => {
          results.push({
            pharmacyId: pharmacy._id,
            pharmacyName: pharmacy.pharmacyName || pharmacy.storeName || pharmacy.name,
            address: pharmacy.shopAddress || pharmacy.address || "Address not available",
            medicineName: m.name,
            price: m.price,
            stock: m.stock,
          });
        });
    });

    res.json(results);
  } catch (err) {
    console.error("Error searching medicines:", err);
    res.status(500).json({ message: "Error searching medicines âŒ" });
  }
});

// Suggestion Route for Autocomplete
app.get("/api/suggest-medicine", async (req, res) => {
  try {
    const { term } = req.query;
    if (!term) return res.json([]);

    const regex = new RegExp(term, "i");
    const pharmacies = await PharmacyProfile.find({ "medicines.name": regex });

    const allNames = [];
    pharmacies.forEach((p) =>
      p.medicines.forEach((m) => {
        if (regex.test(m.name)) allNames.push(m.name);
      })
    );

    const unique = [...new Set(allNames)].slice(0, 10);
    res.json(unique);
  } catch (err) {
    console.error("Error fetching suggestions:", err);
    res.status(500).json({ message: "Error fetching suggestions âŒ" });
  }
});

// ================== SERVER ==================
const PORT = 5000;
// -------------------- CUSTOMER SEND REQUEST --------------------
app.post("/api/request", async (req, res) => {
  try {
    const { pharmacyId, customerName, medicineName } = req.body;

    if (!pharmacyId || !customerName || !medicineName) {
      return res.status(400).json({ message: "Missing required fields âŒ" });
    }

    const time = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
    const newRequest = new Request({
      pharmacyId,
      customerName,
      medicineName,
      time,
    });

    await newRequest.save();
    res.json({ message: "Request sent successfully âœ…" });
  } catch (err) {
    console.error("Error creating request:", err);
    res.status(500).json({ message: "Error sending request âŒ" });
  }
});

// âœ… Get pharmacy by ID (with medicines)
app.get("/api/pharmacy/id/:id", async (req, res) => {
  try {
    const { id } = req.params;

    // Try both ObjectId and String match
    const pharmacy =
      (await PharmacyProfile.findById(id)) ||
      (await PharmacyProfile.findOne({ _id: id }));

    if (!pharmacy) {
      return res.status(404).json({ message: "Pharmacy not found âŒ" });
    }

    res.json(pharmacy);
  } catch (error) {
    console.error("Error fetching pharmacy:", error);
    res.status(500).json({ message: "Server error âŒ" });
  }
});
// ===================== FETCH PHARMACY =====================
async function getPharmacyByIdentifier(identifier) {
  // Check if identifier looks like a MongoDB ObjectId
  const isObjectId = mongoose.Types.ObjectId.isValid(identifier);
  let pharmacy;

  if (isObjectId) {
    pharmacy = await PharmacyProfile.findById(identifier);
  }
  
  // Fallback to email search if not found by ID or identifier is not ObjectId
  if (!pharmacy) {
    pharmacy = await PharmacyProfile.findOne({ email: identifier });
  }

  return pharmacy; // Could be null if nothing found
}

// -------------------- GET PHARMACY PROFILE --------------------
app.get("/api/pharmacy/:identifier/profile", async (req, res) => {
  try {
    const pharmacy = await getPharmacyByIdentifier(req.params.identifier);
    if (!pharmacy) return res.status(404).json({ message: "Pharmacy not found âŒ" });

    res.json({
      _id: pharmacy._id,
      userId: pharmacy.userId,
      fullName: pharmacy.fullName,
      name: pharmacy.name,
      email: pharmacy.email,
      phone: pharmacy.phone,
      address: pharmacy.address,
      bio: pharmacy.bio,
      storeName: pharmacy.storeName,
      pharmacyName: pharmacy.pharmacyName,
      licenseNumber: pharmacy.licenseNumber,
      memberSince: pharmacy.memberSince,
      shopAddress: pharmacy.shopAddress,
      shopPhone: pharmacy.shopPhone,
      shopDescription: pharmacy.shopDescription,
      shopHours: pharmacy.shopHours,
      profilePhoto: pharmacy.profilePhoto,
      shopPhoto: pharmacy.shopPhoto,
      medicines: pharmacy.medicines || [],
    });
  } catch (err) {
    console.error("Error fetching pharmacy profile:", err);
    res.status(500).json({ message: "Error fetching pharmacy profile âŒ" });
  }
});

// -------------------- UPDATE PHARMACY PROFILE --------------------
app.put("/api/pharmacy/:identifier/updateProfile", async (req, res) => {
  try {
    const pharmacy = await getPharmacyByIdentifier(req.params.identifier);
    if (!pharmacy) return res.status(404).json({ message: "Pharmacy not found âŒ" });

    const allowedFields = [
      "fullName", "name", "phone", "address", "bio",
      "pharmacyName", "licenseNumber", "shopAddress",
      "shopPhone", "shopDescription", "shopHours",
      "profilePhoto", "shopPhoto", "storeName", "email"
    ];

    allowedFields.forEach((field) => {
      if (req.body[field] !== undefined) pharmacy[field] = req.body[field];
    });

    await pharmacy.save();
    res.json({ message: "Profile updated successfully âœ…", pharmacy });
  } catch (err) {
    console.error("Error updating pharmacy profile:", err);
    res.status(500).json({ message: "Error updating profile âŒ" });
  }
});


app.listen(PORT, () => console.log(`ðŸš€ Server running on http://localhost:${PORT}`));
